# Gluceel Frontend

واجهات HTML بسيطة للاشتراك وتسجيل الدخول مع Supabase.

## جدول Supabase `users` باختصار (بالعربي)
قبل ما تشغّل التسجيل/الدخول من الصفحات، تأكد أن جدول `users` مضبوط عشان الـ Auth يخزن الـ UUID الصحيح بدل أرقام عشوائية.

### أنواع الأعمدة المطلوبة
| العمود | النوع | ملاحظات |
| --- | --- | --- |
| `id` | `uuid` | لازم يطابق User ID اللي Supabase Auth بيرجعه؛ خليه Primary Key و`not null`. |
| `email` | `text` | يفضل يكون `not null` و`unique` لتجنب التكرار. |
| `name` | `text` | اسم عرض اختياري. |
| `role` | `text` | افتراضيًا `user` لو مش محتاج أدوار إضافية. |
| `status` | `text` | حالات مثل `active` / `pending` / `disabled`. |
| `created_at` | `timestamp with time zone` | خلي الـ Default `now()` عشان الصف يضاف تلقائيًا.

> لو الـ `id` عندك حاليًا رقم أو `text` بدل `uuid`:
> 1. من Table editor في Supabase غيّر نوع العمود لـ `uuid`.
> 2. اربطه بـ Auth عن طريق Foreign Key على `auth.users(id)`.
> 3. لو فيه بيانات قديمة، حدّثها بالـ UUID الصحيح لكل مستخدم (من جدول Auth أو بالـ API).

### سياسات Row Level Security (RLS)
فعّل RLS على جدول `users` وأضاف سياسات واضحة:
- **Select:** المستخدم يشوف صفه بس (`id = auth.uid()`).
- **Insert:** المستخدم يضيف صف لنفسه بس (`id = auth.uid()`).
- **Update:** المستخدم يعدّل صفه بس.

لو عندك دور مدير (admin) مبني على Claim في الـ JWT، أضف سياسة منفصلة تسمح له بالوصول الأشمل.

### خطوات التحقق السريعة
1. افتح جدول `users` وتأكد الأنواع زي الجدول اللي فوق وخصوصًا إن `id` = `uuid`.
2. تأكد RLS مفعّل وفيه سياسات select/insert/update زي المذكور.
3. شغّل سكربت SQL الجاهز في ملف `sql/users_schema_fix.sql` من خلال **SQL Editor** في لوحة Supabase (الصورة التوضيحية في طلبك هي القائمة المطلوبة). السكربت يبدأ بحذف **كل** سياسات RLS الموجودة على جدول `users` مؤقتًا لتجنب رسالة "cannot alter type of a column used in a policy definition"، ثم يضبط الأنواع والربط مع `auth.users`، يضيف قيود فريدة على البريد، يفعل RLS، وينشئ السياسات اللازمة من جديد.
4. بعد الحفظ وتشغيل السكربت، جرّب التسجيل/الدخول من `index.html` و`register.html` وشوف إن المستخدم الجديد بيتخزن بـ UUID صح في `users`.

## لو التسجيل/الدخول رفض الطلب
- في الصفحتين يوجد صندوق أصفر باسم **تفاصيل الخطأ** يظهر السبب القادم من Supabase (مثل قيود RLS، نوع العمود، أو المفتاح المكرر).
- انسخ الرسالة كما هي وأرسلها للمسؤول ليتم مراجعة جدول `users` أو السياسات بناءً على نص الخطأ.

## قبل ما نرفع الموقع على الإنترنت (مش شبكة محلية)
- حدّث إعداد **Site URL** و **Redirect URLs** في لوحة Supabase Auth ليكون الدومين الحقيقي (مثل `https://example.com`) بدل `http://localhost`. لو تركتها على `localhost` هترجع أخطاء توثيق أو CSRF بعد تسجيل الدخول.
- تحت تبويب **Email** في Supabase، فعّل **Email provider** وألغِ خيار **Confirm email** إذا عايز دخول فوري بدون رسالة تفعيل. لو الـ Confirm email مفعّل، المستخدم الجديد هيتطلب فتح الرابط قبل إنشاء جلسة دخول.
- تأكد أن **Allow new users to sign up** و **Allow email link/anonymous sign-ins** مضبوطين حسب احتياجك. في الأغلب هنحتاج: email مفعّل، anonymous مغلق، و MFA غير ضروري.
- لو هتستخدم أدوار أطباء/مديرين، احتفظ بسياسة RLS اللي بتخلي حساب الطبيب في حالة pending (`status = 'pending'`) لحد ما مدير يفعّله.

## البيانات اللي أحتاجها عشان أشخّص أي رفض تسجيل/دخول بسرعة
1) نص الخطأ الظاهر في صندوق **تفاصيل الخطأ** أو في وحدة التحكم (Console) بالمتصفح.
2) تأكيد القيم الحالية في لوحة Supabase Auth:
   - Site URL و Redirect URLs.
   - حالة Confirm email و Email provider (مفعّل/معطّل).
   - لقطة شاشة من تبويب RLS Policies لجدول `users`.
3) من جدول `users`: نوع عمود `id` (لازم `uuid`) وأي قيود فريدة على البريد.
4) لو في حجب من الشبكة، صورة من Network tab للملف `js/supabase-config.js` وطلبات `https://*.supabase.co` توضح حالة 200/403.

## إزاي أراجع لقطات الشاشة بسرعة (الصح والخطأ)
- **إعدادات البريد/التسجيل (Auth → Email):**
  - الصح: خيار **Confirm email** مطفأ لو عايز تسجيل ودخول فوري بدون رسالة تأكيد. مزوّد البريد (Email provider) مفعّل أو SMTP مضبوط.
  - الخطأ الشائع: ترك **Confirm email** مفعّل أو تعطيل Email provider، ساعتها Supabase يرفض إنشاء الجلسة أو يبعت رابط تفعيل مش مطلوب.
  - التصحيح: أوقف Confirm email، فعل Email provider، واضبط Site URL و Redirect URLs على دومين الموقع الحقيقي (مش localhost).

- **جدول `users` (Table editor):**
  - الصح: عمود `id` نوعه `uuid` ومفتاح أساسي ومربوط بـ `auth.users(id)`، وعمود `email` `text` مع `unique` و`not null`، وباقي الحقول (`name`, `role`, `status`, `created_at`) بأنواع النص/التاريخ مع Default `now()` للوقت.
  - الخطأ الشائع: `id` لازال `integer` أو `text`، أو بدون ربط بجدول Auth، أو بريد بدون قيود فريدة مما يسبب رفض إدخال أو تضارب.
  - التصحيح: شغّل سكربت `sql/users_schema_fix.sql` في SQL Editor ليحوّل العمود لـ `uuid`، يربطه بـ Auth، ويفعّل القيود الافتراضية.

- **سياسات RLS (Policies):**
  - الصح: ثلاث سياسات للمستخدم العادي (select/insert/update بشرط `id = auth.uid()`) وسياسة اختيارية `users_admin_full_access` لو عندك دور مدير مبني على JWT.
  - الخطأ الشائع: سياسات قديمة تربط بالعمود `id` قبل تحويله لـ `uuid` أو عدم وجود سياسات بعد تفعيل RLS فيمنع كل العمليات.
  - التصحيح: السكربت `sql/users_schema_fix.sql` يحذف كل السياسات القديمة ويعيد إنشاء السياسات الصحيحة تلقائيًا. تأكد بعدها أن RLS **مفعّل**.

- **لقطة الأخطاء من الصفحات:**
  - الصح: صندوق **تفاصيل الخطأ** في الصفحات يعرض نص الخطأ القادم من Supabase (مثلاً "violates row-level security" أو مشكلة `uuid`).
  - التصحيح: انقل النص كما هو، وافتح SQL Editor لتطبيق السكربت ثم جرّب التسجيل/الدخول مرة أخرى.
