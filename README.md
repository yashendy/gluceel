# Gluceel Frontend

واجهات HTML بسيطة للاشتراك وتسجيل الدخول مع Supabase.

## جدول Supabase `users` باختصار (بالعربي)
قبل ما تشغّل التسجيل/الدخول من الصفحات، تأكد أن جدول `users` مضبوط عشان الـ Auth يخزن الـ UUID الصحيح بدل أرقام عشوائية.

### أنواع الأعمدة المطلوبة
| العمود | النوع | ملاحظات |
| --- | --- | --- |
| `id` | `uuid` | لازم يطابق User ID اللي Supabase Auth بيرجعه؛ خليه Primary Key و`not null`. |
| `email` | `text` | يفضل يكون `not null` و`unique` لتجنب التكرار. |
| `name` | `text` | اسم عرض اختياري. |
| `role` | `text` | افتراضيًا `user` لو مش محتاج أدوار إضافية. |
| `status` | `text` | حالات مثل `active` / `pending` / `disabled`. |
| `created_at` | `timestamp with time zone` | خلي الـ Default `now()` عشان الصف يضاف تلقائيًا.

> لو الـ `id` عندك حاليًا رقم أو `text` بدل `uuid`:
> 1. من Table editor في Supabase غيّر نوع العمود لـ `uuid`.
> 2. اربطه بـ Auth عن طريق Foreign Key على `auth.users(id)`.
> 3. لو فيه بيانات قديمة، حدّثها بالـ UUID الصحيح لكل مستخدم (من جدول Auth أو بالـ API).

### سياسات Row Level Security (RLS)
فعّل RLS على جدول `users` وأضاف سياسات واضحة:
- **Select:** المستخدم يشوف صفه بس (`id = auth.uid()`).
- **Insert:** المستخدم يضيف صف لنفسه بس (`id = auth.uid()`).
- **Update:** المستخدم يعدّل صفه بس.

لو عندك دور مدير (admin) مبني على Claim في الـ JWT، أضف سياسة منفصلة تسمح له بالوصول الأشمل.

### خطوات التحقق السريعة
1. افتح جدول `users` وتأكد الأنواع زي الجدول اللي فوق وخصوصًا إن `id` = `uuid`.
2. تأكد RLS مفعّل وفيه سياسات select/insert/update زي المذكور.
3. شغّل سكربت SQL الجاهز في ملف `sql/users_schema_fix.sql` من خلال **SQL Editor** في لوحة Supabase (الصورة التوضيحية في طلبك هي القائمة المطلوبة). السكربت يبدأ بحذف **كل** سياسات RLS الموجودة على جدول `users` مؤقتًا لتجنب رسالة "cannot alter type of a column used in a policy definition"، ثم يضبط الأنواع والربط مع `auth.users`، يضيف قيود فريدة على البريد، يفعل RLS، وينشئ السياسات اللازمة من جديد.
4. بعد الحفظ وتشغيل السكربت، جرّب التسجيل/الدخول من `index.html` و`register.html` وشوف إن المستخدم الجديد بيتخزن بـ UUID صح في `users`.

## لو التسجيل/الدخول رفض الطلب
- في الصفحتين يوجد صندوق أصفر باسم **تفاصيل الخطأ** يظهر السبب القادم من Supabase (مثل قيود RLS، نوع العمود، أو المفتاح المكرر).
- انسخ الرسالة كما هي وأرسلها للمسؤول ليتم مراجعة جدول `users` أو السياسات بناءً على نص الخطأ.

## للتشغيل على نطاق عام (إنترنت)
قبل نشر الصفحات خارج الشبكة المحلية، راجع الإعدادات التالية لتفادي أخطاء عدم الاتصال أو منع التسجيل:
- **Site URL / Redirect URLs:** في Supabase > Authentication > URL Configuration حدّث `Site URL` ليطابق نطاقك العام (HTTPS) وأضف نفس النطاق في Redirect URLs. استخدام `localhost` فقط قد يرفض الجلسات على دومين آخر.
- **مفتاح anon كامل:** المفتاح في `js/supabase-config.js` يجب أن يكون النسخة الكاملة من Project Settings > API > `anon public`. المفتاح المبتور أو القصير يؤدي لرسائل `invalid apikey` في المتصفح.
- **فتح الصفحات عبر خادم:** شغّل الصفحات من نطاق HTTP/HTTPS (GitHub Pages أو استضافة ثابتة). فتح الملفات مباشرة بـ `file://` يجعل المتصفح يمنع استيراد الـ modules ويظهر خطأ `supabase is not defined`.
- **تفعيل/تعطيل تأكيد البريد:** لو أردت تسجيلًا فوريًا بدون تأكيد بريد، عطّل خيار Confirm Email في Auth Providers > Email. لو كان مفعّل سيحتاج المستخدم ضغط رابط البريد قبل إنشاء الجلسة.

### البيانات المطلوبة للتشخيص السريع
لأي فشل تسجيل/دخول، أرسل التفاصيل التالية لنحدد الخطأ مباشرة:
1) لقطة من تبويب **Console** و **Network** في DevTools توضح رسالة الخطأ (خاصة `supabase-config.js` وطلبات `/auth/v1` و`/rest/v1/users`).
2) لقطة من إعدادات **Authentication > URL Configuration** تبين Site URL و Redirect URLs بعد التحديث للدومين العام.
3) نص رسالة الخطأ التي تظهر في صندوق **تفاصيل الخطأ** الأصفر داخل الصفحة.
4) تأكيد حالة جدول `public.users`: نوع عمود `id` (`uuid`)، ربطه بـ `auth.users(id)`, وتفعيل RLS مع السياسات (select/insert/update) الموضحة أعلاه.
